---
title: LLM-Extraction Project - main Analysis
author: "Johannes Schwenke"
date: today
format: 
  typst:
    papersize: a4
    margin:
      x: 2cm
      y: 2.5cm
    toc: true
    section-numbering: 1.1.1
    columns: 1
    tbl-cap-location: bottom
---

{{< pagebreak >}}

```{r load-data}
#| echo: false
#| output: false
data <- read_parquet(here("data","oncology","analysis_data.parquet"))
```

## Table 1

```{r n-pet}
#| echo: false
#| output: false
# prep for table 1 - n-PET-CT
modality_tbl <- analysis_data_human |>
  distinct(ier_bk, pet_ct) |>
  count(pet_ct, name = "n") |>
  mutate(label = ifelse(pet_ct, "PET–CT", "CT/MRI")) |>
  arrange(desc(pet_ct)) |>
  mutate(pct = n / sum(n),
         Value = glue("{n} ({percent(pct, accuracy = 0.1)})")) |>
  transmute(Variable = "Imaging modality",
            Category = label,
            Value)
```

```{r n-sex}
# prep for table 1 - sex

```

```{r n-age}
# prep for table 1 - age

```

```{r top3-diagnosis}
#| echo: false
#| output: false
# prep for table 1 - three most common diagnoses 
diag_top3 <- analysis_data_human |>
  filter(task == "Diagnosis") |> 
  distinct(ier_bk, truth) |> 
  count(truth, sort = TRUE, name = "n") |>
  mutate(pct = n / sum(n),
         Value = glue("{n} ({percent(pct, accuracy = 0.1)})")) |>
  slice_head(n = 3) |>
  transmute(Variable = "Top 3 diagnoses",
            Category = truth,
            Value)
```

```{r any-metastasis}
#| echo: false
#| output: false
# prep for table 1 - at least a metastasis
tbl_mets_any <- tibble::tibble(
  Variable = "Metastasis (patients)",
  Category = "Any metastasis",
  Value = sprintf("%d (%.1f%%)", n_mets_patients, 100 * n_mets_patients / n_total_patients)
)
```

```{r top3-metastasis}
#| echo: false
#| output: false
# prep for table 1 - Top 3 lok. of metastasis
tbl_mets_top3 <- analysis_data_human |>
  filter(task == "Metastasis") |>
  mutate(truth = tolower(trimws(truth))) |>
  filter(truth %in% c("yes","true","1")) |>
  count(item, name = "n") |>
  arrange(desc(n)) |>
  mutate(pct = n / sum(n),
         Value = sprintf("%d (%.1f%%)", n, 100 * pct)) |>
  slice_head(n = 3) |>
  transmute(Variable = "Metastasis localization (top 3)",
            Category = item,
            Value)
```

```{r tbl-response-to-treatment}
#| echo: false
#| output: false
#prep for table 1 - rtt categories and distribution
resp_tbl <- analysis_data_human |>
  filter(task == "Response to Treatment") |>
  distinct(ier_bk, pet_ct, truth) |>
  mutate(
    Category = str_trim(truth),
    Category = ifelse(is.na(Category) | Category == "", "NA", Category)
  ) |>
  count(pet_ct, Category, name = "n") |>
  group_by(pet_ct) |>
  mutate(
    p = n / sum(n),
    Value = sprintf("%d (%.1f%%)", n, 100 * p),
    Variable = paste0("Treatment response (", ifelse(pet_ct, "PET–CT", "CT/MRI"), ")")
  ) |>
  arrange(Variable, desc(n)) |>
  ungroup() |>
  select(Variable, Category, Value)
```

```{r tb-tumor_free-yes-no-na}
#| echo: false
#| output: false
tf_tbl <- analysis_data_human |>
  filter(task == "Radiologically Tumor Free") |>
  distinct(ier_bk, truth) |>
  mutate(
    Category = as.character(truth),             
    Category = ifelse(is.na(Category) | Category == "", "NA", Category)
  ) |>
  count(Category, name = "n") |>
  mutate(
    p = n / sum(n),
    Value = sprintf("%d (%.1f%%)", n, 100 * p)
  ) |>
  arrange(desc(n)) |>
  transmute(
    Variable = "Tumor-free status",
    Category,
    Value
  )
```

```{r tb-01}
#| echo: false
table1_df <- bind_rows(
  modality_tbl,
  diag_top3,     
  tbl_mets_any,
  tbl_mets_top3,
  resp_tbl,
  tf_tbl)

table1 <- gt(
  table1_df, 
  rowname_col = "Category", 
  groupname_col = "Variable") |>
  tab_header(title = md("**Table 1.**")) |>
  cols_label(Value = "n (%)") |>
  fmt_missing(
    columns = everything(), 
    missing_text = "—") |>
  tab_options(
    table.font.size = px(13), 
    data_row.padding = px(6),
    row_group.background.color = "#fbf5d6ff") |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  ) |>
  opt_row_striping() 

out_dir <- here::here("output", "oncology", "figures")
dir.create(out_dir, recursive = TRUE, showWarnings = FALSE)
gt::gtsave(table1, filename = "table1.docx", path = out_dir)
```

{{< pagebreak >}}

## LLM vs Human

```{r prep-data-analysis-optim-sample}
#| echo: false
full_sample <- analysis_data |> 
  mutate(
    human = if_else(!str_detect(redcap_event_name, "LLM"), 1, 0),
    grp = case_when(
      human == 1 ~ "human",
      model == "llama3.3:70b-instruct-q5_K_M" | model == "llama3.3:70b" ~ "llama3.3:70b",
      model == "mistral-small:24b-instruct-2501-q4_K_M" | model == "mistral-small:24b" ~ "mistral-small:24b",
      model == "rndcalcle01.qwen3:32b" | model == "qwen3:32b" ~ "qwen3:32b",
      model == "rndcalcle01.qwq:32b" | model == "qwq:32b" ~ "qwq:32b",
      model == "gpt-oss:120b" ~ "gpt-oss:120b",
    ),
    grp = factor(grp, levels = c("human", "llama3.3:70b", "mistral-small:24b", "qwen3:32b", "qwq:32b",  "gpt-oss:120b")) )

analysis_sample <- full_sample |> 
  group_by(ier_bk) |> 
  filter(any(training == "No")) |> 
  ungroup()

optim_sample <- full_sample |> 
  group_by(ier_bk) |> 
  filter(any(training == "Yes")) |> 
  ungroup()
```

```{r theme-for-figs}
#| echo: false
# Reusable theme for figs
theme_medical <- function(base_size = 11, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      panel.grid.major.x = element_line(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor   = element_blank(),
      axis.title = element_text(face = "bold"),
      axis.text  = element_text(color = "black"),
      axis.line  = element_line(linewidth = 0.4),
      axis.ticks = element_line(linewidth = 0.4),
      legend.position = "bottom",
      legend.direction = "horizontal",
      plot.margin = margin(5.5, 7, 5.5, 5.5)
    )
}
```

### Primary endpoints: (response to treatment, metastasis status)

```{r model}
#| echo: false
m_acc <- glm(
    correct ~ grp * task,
    data = analysis_sample  |> filter(task == "Metastasis" | task == "Response to Treatment"),
    family = binomial(link = "logit")
  )
```

```{r predictions-comparisons}
#| echo: false
#| output: false
avg_predictions(m_acc, by = c("grp", "task"), type = "response", vcov = ~ier_bk)
avg_comparisons(m_acc, variable = "grp", by = "task", type = "response", vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9)
```

#### Table for predictions and comparisons

```{r tbl-acc-primary-endpoints}
#| echo: false

# Order for groups (legend/rows) 
ord <- c(
  "human",
  "gpt-oss:120b",
  "qwen3:32b",
  "qwq:32b",
  "mistral-small:24b",
  "llama3.3:70b")

# Predicted accuracies by task × group 
pred <- avg_predictions(
  m_acc, by = c("grp", "task"), type = "response", vcov = ~ ier_bk
) |>
  data.frame() |>
  transmute(
    task, grp,
    acc_est  = estimate, acc_low = conf.low, acc_high = conf.high,
    Accuracy = sprintf("%.1f%% (%.1f–%.1f%%)", 100*acc_est, 100*acc_low, 100*acc_high)
  )
# Group vs. human comparisons within each task 
comp <- avg_comparisons(
  m_acc, variable = "grp", by = "task", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |>
  data.frame() |>
  mutate(
    grp = str_replace(contrast, "\\s*-\\s*human$", ""),    
    noninferior = conf.low > -0.05
  ) |>
  transmute(
    task, grp,
    `Model vs human` = sprintf("%+.1f pp (%.1f to %.1f)", 100*estimate, 100*conf.low, 100*conf.high),
    `NI (Δ > -5pp)`  = if_else(noninferior, "yes", "no")
  )

# table
tab <- pred |>
  left_join(comp, by = c("task", "grp")) |>
  mutate(grp = factor(grp, levels = ord)) |>
  arrange(task, grp) |>
  mutate(
    `Model vs human` = if_else(grp == "human", "", `Model vs human`),
    `NI (Δ > -5pp)`  = if_else(grp == "human", "", `NI (Δ > -5pp)`)
  ) |>
  select(task, grp, Accuracy, `Model vs human`, `NI (Δ > -5pp)`)

pred_tbl <- gt(tab, groupname_col = "task") |>
  cols_label(
    task = "Task",
    grp  = "Group",
    Accuracy = "Accuracy (95% CI)",
    `Model vs human` = "Difference vs human (pp)",
    `NI (Δ > -5pp)`  = "Non-inferior?"
  ) |>
  tab_options(data_row.padding = px(4))

# Export table 
gt::gtsave(
  pred_tbl,
  filename = here::here("output", "oncology", "figures", "Accuracy_table_primary.docx")
)
```

#### Main Fig. Difference & Accuracy: primary endpoints
```{r}
#| fig-width: 
#| fig-height:
#| fig-cap: "Difference & Accuracy Plot:  primary endppoints"
#| echo: false
#| warning: false

# ---- Colors & legend order (Okabe–Ito) -------------------------------------
okabe_ito_named <- c(
  human               = "#000000",
  "gpt-oss:120b"      = "#E69F00",
  "qwen3:32b"         = "#56B4E9",
  "qwq:32b"           = "#009E73",
  "mistral-small:24b" = "#0072B2",
  "llama3.3:70b"      = "#D55E00"
)

ord_legend   <- c("human","gpt-oss:120b","qwen3:32b","qwq:32b","mistral-small:24b","llama3.3:70b")
model_levels <- setdiff(ord_legend, "human")                 # models only
contrast_lvls <- paste0(model_levels, " - human")            # contrasts shown below
wanted_levels <- rev(contrast_lvls)                          # desired order (top to bottom)

# color palette for contrasts in the difference plots
contrast_palette <- setNames(okabe_ito_named[model_levels], contrast_lvls)

# shared scales for the top row (accuracy plots): keep only color legend
shared_color <- scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE, name = "")
shared_fill  <- scale_fill_manual(values  = okabe_ito_named, breaks = ord_legend, drop = FALSE, name = "", guide = "none")

# ---- DATA for difference plots ---------------------------------------------
dfm <- avg_comparisons(
  m_acc,
  newdata = analysis_sample |> filter(task == "Metastasis"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> data.frame()

dfrtt <- avg_comparisons(
  m_acc,
  newdata = analysis_sample |> filter(task == "Response to Treatment"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> data.frame()

# apply factor order
dfm$contrast   <- factor(dfm$contrast,   levels = wanted_levels)
dfrtt$contrast <- factor(dfrtt$contrast, levels = wanted_levels)

# shared y-limits for both difference panels
lims <- range(c(dfm$conf.low, dfm$conf.high, dfrtt$conf.low, dfrtt$conf.high, -0.05, 0), na.rm = TRUE)

# ---- TOP ROW: Accuracy by task (A, B) --------------------------------------
pA <- plot_predictions(
  m_acc,
  newdata = analysis_sample |> filter(task == "Metastasis"),
  by = c("task", "grp"),
  type = "response",
  vcov = ~ ier_bk
) +
  shared_color + shared_fill +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  labs(x = NULL, y = "Probability of Correct Response", title = "Metastasis", color = "") +
  theme_medical() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_blank())

pB <- plot_predictions(
  m_acc,
  newdata = analysis_sample |> filter(task == "Response to Treatment"),
  by = c("task", "grp"),
  type = "response",
  vcov = ~ ier_bk
) +
  shared_color + shared_fill +
  scale_y_continuous(limits = c(0, 1), breaks = seq(0, 1, 0.1)) +
  labs(x = NULL, y = NULL, title = "Response to Treatment", color = "") +
  theme_medical() +
  theme(panel.grid.major.y = element_line(),
        panel.grid.major.x = element_blank(),
        axis.text.x = element_blank())

# ---- BOTTOM ROW: Difference vs human (C, D) --------------------------------
base_diff_theme <- theme_medical() +
  theme(axis.text.y  = element_blank(),
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank())

p1 <- ggplot(dfm, aes(x = contrast, y = estimate, color = contrast)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  scale_color_manual(values = contrast_palette, breaks = contrast_lvls, labels = model_levels, drop = FALSE) +
  coord_flip() +
  labs(x = NULL, y = NULL) +
  base_diff_theme +
  guides(color = "none", fill = "none")

p2 <- ggplot(dfrtt, aes(x = contrast, y = estimate, color = contrast)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0, linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  scale_color_manual(values = contrast_palette, breaks = contrast_lvls, labels = model_levels, drop = FALSE) +
  coord_flip() +
  labs(x = NULL, y = NULL) +
  base_diff_theme +
  guides(color = "none", fill = "none")

# ---- Assemble: one shared legend at the bottom -----------------------------
full_fig_primary <-
  (pA | pB) /
  (p1 | p2) +
  plot_layout(guides = "collect", heights = c(1, 1)) +
  plot_annotation(
    title     = "Primary endpoints",
    subtitle  = "Top: accuracy by task and group • Bottom: difference vs. human",
    caption   = "Colors: Okabe–Ito palette",
    tag_levels = "A"        
  ) &
  theme(
    legend.position = "bottom",
    legend.justification = "center",
    # styling/position for the A–D tags:
    plot.tag = element_text(face = "bold", size = 12),
    plot.tag.position = c(0.015, 0.98)  # left/top inside each panel; tweak if needed
  )

full_fig_primary


# ---- Save -------------------------------------------------------------------
ggsave(
  filename = here::here("output", "oncology", "figures", "full_fig_primary.png"),
  plot = full_fig_primary, width = 8, height = 12, dpi = 300
)
```

### Secondary endpoints

```{r model-predictions-comparisons-Diagnosis-RadiologicallyTumorFree}
#| echo: false
#| output: false

m_acc2 <- glm(
    correct ~ grp * task,
    data = analysis_sample  |> filter(task == "Diagnosis" | task == "Radiologically Tumor Free"),
    family = binomial(link = "logit")
  )

avg_predictions(m_acc2, by = c("grp", "task"), type = "response", vcov = ~ier_bk)
avg_comparisons(m_acc2, variable = "grp", by = "task", type = "response", vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9)
```

```{r model-predictions-comparisons-Overall}
#| echo: false
#| output: false

m_acc3 <- glm(
    correct ~ grp * task,
    data = analysis_sample, 
    family = binomial(link = "logit") )

avg_predictions(m_acc3,by = "grp", type = "response", vcov = ~ ier_bk)
avg_comparisons(m_acc3, variable = "grp", type = "response", vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9)
```

#### Diffrence plot: secondary endpoints

```{r fig-diff-secondary-endpoints}
#| echo: false
#| warning: false
#| fig-cap: ""
#| fig-height: 3.5
#| fig-width: 6

## 1) DATA --------------------------------------------------------

# Diagnosis
dfd <- avg_comparisons(
  m_acc2,
  newdata = analysis_sample |> filter(task == "Diagnosis"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> 
  data.frame()

# Tumor free
dfrtf <- avg_comparisons(
  m_acc2,
  newdata = analysis_sample |> filter(task == "Radiologically Tumor Free"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> 
  data.frame()

# Overall accuracy
dfover <- avg_comparisons(
  m_acc3,
  variable = "grp", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> 
  data.frame()

dfd$contrast   <- factor(dfd$contrast,   levels = wanted_levels)
dfrtf$contrast <- factor(dfrtf$contrast, levels = wanted_levels)
dfover$contrast<- factor(dfover$contrast,levels = wanted_levels)

## 2) LIMITS ------------------------------------------------------
lims <- range(
  c(
    dfd$conf.low,   dfd$conf.high,
    dfrtf$conf.low, dfrtf$conf.high,
    dfover$conf.low,dfover$conf.high,
    -0.05, 0
  ),
  na.rm = TRUE
)

## 3) PLOTS -------------------------------------------------------

p_diag <- ggplot(dfd, aes(x = contrast, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(title = "Diagnosis", x = NULL) +
  theme_medical()

p_tf <- ggplot(dfrtf, aes(x = contrast, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(title = "Radiologically Tumor Free", x = NULL) +
  theme_medical()

p_over <- ggplot(dfover, aes(x = contrast, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(title = "Overall accuracy", x = NULL) +
  theme_medical()

## 4) PATCHWORK ---------------------------------------------------

combined_sec <- p_diag / p_tf / p_over + plot_annotation(tag_levels = "A")

combined_sec   

## 5) SAVE --------------------------------------------------------------

ggsave(
  filename = here("output", "oncology", "figures", "secondary_contrast.png"),
  plot = combined_sec,
  width = 8, height = 10.5, dpi = 300
)
```

#### Accuracy by task (diagnosis, tumorfree) and group

```{r fig-acc-secondary-endpoints}
#| fig-width: 8
#| fig-height: 6
#| fig-cap: "Accuracy by Task and Group (Human vs LLM)"
#| echo: false
#| warning: false

# --- PLOT 1: Diagnosis -------------------------------------------------------
p1 <- plot_predictions(m_acc2, newdata = analysis_sample |> filter(task == "Diagnosis"), 
                       by = c("task", "grp"), type = "response", vcov = ~ier_bk) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2)) +
  scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  scale_fill_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  labs(x = "Diagnosis", y = "Probability of Correct Response", color = "") +
  theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank()
  )

# --- PLOT 2: Radiologically Tumor Free --------------------------------------
p2 <- plot_predictions(m_acc2, newdata = analysis_sample |> filter(task == "Radiologically Tumor Free"), 
                       by = c("task", "grp"), type = "response", vcov = ~ier_bk) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2)) +
  scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  scale_fill_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  labs(x = "Radiologically Tumor Free", y = NULL, color = "") +
  theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank()
  )
# --- PLOT 3: Overall (single x level "overall") ------------------------------
ap <- avg_predictions(
  m_acc3,
  by   = "grp",
  type = "response",
  vcov = ~ ier_bk
) |>
  mutate(xlab = "overall")   

pd <- position_dodge(width = 0.2)

p3 <- ggplot(ap, aes(x = xlab, y = estimate, color = grp)) +  
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), position = pd, size = 0.5, linewidth = 0.5) +
  scale_x_discrete(limits = "overall") +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2)) +
  scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  scale_fill_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  labs(x = "Overall", y = NULL, color = "") +
  theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
        axis.text.x = element_blank(),
    legend.position = ""
  )
# --- COMBINE ----------------------------------------------------------------
combined_Acc <- p1 + p2 + p3 + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect")  & theme(legend.position = "bottom")

# Preview in the document
combined_Acc

# --- SAVE ---------------------------------------------------------------------
ggsave(
  filename = here::here("output", "oncology", "figures", "secondary_accuracy.png"),
  plot = combined_Acc,
  width = 8, height = 7, dpi = 300
)
```

{{< pagebreak >}}

## Bar Plot Metastasis

```{r bar-plot-meta}
analysis_sample |> 
  filter(task == "Metastasis") |>
  mutate(
    y = case_when(
      truth == "Yes" & correct == 1 ~ "True Positive",
      truth == "Yes" & correct == 0 ~ "False Negative",
      truth == "No"  & correct == 1 ~ "True Negative",
      truth == "No"  & correct == 0 ~ "False Positive",
    ),
    item = gsub("_metastasis$", "", item),
    item = gsub("_",  " ", item)
  ) |> 
    ggplot(aes(x = item, fill = y)) +
    geom_bar(position = "fill") +
    scale_fill_manual(
    values = c(
      "True Positive"  = "#0868ac", # dark blue
      "True Negative"  = "#67a9cf", # light blue
      "False Positive" = "#cb181d", # dark red
      "False Negative" = "#fb6a4a"  # light red
    ),
    drop = FALSE) +
    facet_wrap(~grp) +
    coord_flip() +
    labs(
      x = "Metastasis Location",
      y = "Proportion",
      fill = "Response"
    ) +
      theme(
      legend.position = "bottom"
      )
```

## LLM comparison pre/post prompt refinement

```{r prep-data-old}
#| echo: false
dat_old <- readRDS(here("data", "oncology", "redcap-2025-10-09-labels.rds"))$data

long_data <- dat_old |>
  group_by(redcap_event_name) |>
  pivot_longer(
    cols = c(
      primary_tumor,
      bone_metastasis,
      cns_metastasis,
      meningeal_metastasis,
      lung_metastasis,
      pleural_metastasis,
      adrenal_metastasis,
      kidney_metastasis,
      liver_metastasis,
      spleen_metastasis,
      pancreas_metastasis,
      ovarian_metastasis,
      peritoneal_metastasis,
      lymph_node_metastasis,
      soft_tissue_metastasis,
      other_organ_metastasis,
      no_tumor,
      response_to_trt, 
      response_to_trt_pet
    ),
    names_to = "item",
    values_to = "value"
  ) |> 
  select(-c(oncology_radiology_extraction_complete, justification, prompt, sample_complete)) |> 
  ungroup()

ground_truth_long <- readRDS(here("data", "oncology", "ground_truth_long.rds"))

analysis_data <- long_data |>
    group_by(ier_bk) |> 
    filter(any(training == "Yes")) |> 
    ungroup() |> 
    filter(!redcap_event_name %in% c("Ground Truth", "Extraction 2", "Extraction 1")) |> 
    group_by(ier_bk, redcap_event_name) |>
    mutate(
      value = case_when(
        # I only want to change the value where item == "no_tumor"
        item == "no_tumor" & 
          any(value[item == "response_to_trt" | item == "response_to_trt_pet"] == "Not applicable") ~ "Not applicable",
        TRUE ~ value
      )
    ) |> 
    ungroup() |> 
    left_join(ground_truth_long, by = c("ier_bk", "item")) |> 
    # where NA for ground truth and value, then question was not applicable -> remove
    filter(!is.na(value) & !is.na(truth)) |> 
    mutate(
        correct = if_else(value == truth, 1, 0),
        task  = case_when(
          str_detect(item, "metastasis") ~ "Metastasis",
          str_detect(item, "primary_tumor") ~ "Diagnosis",
          str_detect(item, "response_to_trt") ~ "Response to Treatment",
          str_detect(item, "no_tumor") ~ "Radiologically Tumor Free",
          TRUE ~ NA
        ),
        report_length = nchar(imaging_report)
    )

data_old  <- analysis_data  |> 
  mutate(
    grp = case_when(
      model == "llama3.3:70b-instruct-q5_K_M" | model == "llama3.3:70b" ~ "llama3.3:70b",
      model == "mistral-small:24b-instruct-2501-q4_K_M" | model == "mistral-small:24b" ~ "mistral-small:24b",
      model == "rndcalcle01.qwen3:32b" | model == "qwen3:32b" ~ "qwen3:32b",
      model == "rndcalcle01.qwq:32b" | model == "qwq:32b" ~ "qwq:32b",
    ),
    grp = factor(grp, levels = c("llama3.3:70b", "mistral-small:24b", "qwen3:32b", "qwq:32b")) 
    ) |> 
  mutate (v = "0")
```

```{r prep-data-new}
#| echo: false
data_new <- optim_sample |> 
  mutate ( v = "1") |> 
  filter(!redcap_event_name %in% c("Extraction 1", "Extraction 2"))
```

```{r llm-prompt-refinement-improvement}
#| echo: false
combined <- bind_rows(data_old, data_new)

llm_acc <- glm(
    correct ~ grp * (task + v),
    data = combined,
    family = binomial(link = "logit")
  )

ap <- avg_predictions(llm_acc, newdata = combined |> filter(v == "1"), by = c("grp", "task"), type = "response", vcov = ~ier_bk)
ap
```



