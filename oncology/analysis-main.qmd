---
title: "LLM-Extraction Project"
subtitle: "Figures and Tables for Main Manuscript"
author: "Johannes Schwenke"
date: today
format: 
  typst:
    papersize: a4
    margin:
      x: 2cm
      y: 2.5cm
    toc: true
    section-numbering: 1.1.1
    columns: 1
    tbl-cap-location: bottom
---

## Setup

```{r}
#| output: false
library(here)
library(arrow)
library(glue)
library(scales)
library(gt)
library(tidyverse)
library(marginaleffects)
library(patchwork)
```

```{r load-data}
#| output: false
data <- read_parquet(here("data","oncology","analysis_data.parquet"))

logs <- REDCapR::redcap_log_read(
  redcap_uri = Sys.getenv("redcap_fxdb_url"),
  token = Sys.getenv("llm_radio_api"),
  log_begin_date = as.Date("2025-05-01"),
  log_end_date = as.Date("2025-11-01"),
  record = NULL,
  user = NULL,
  http_response_encoding = "UTF-8",
  locale = readr::default_locale(),
  verbose = TRUE,
  config_options = NULL,
  handle_httr = NULL
)
```

## Table 1

Generate Table 1 summarizing the characteristics of the 400 reports. All of this is based on the ground truth.

```{r n-pet}
#| echo: false
#| output: false
# prep for table 1 - n-PET-CT
modality_tbl <- data |>
  filter(!str_detect(redcap_event_name, "LLM")) |> 
  distinct(ier_bk, pet_ct) |>
  count(pet_ct, name = "n") |>
  mutate(label = ifelse(pet_ct, "PET–CT", "CT/MRI")) |>
  arrange(desc(pet_ct)) |>
  mutate(pct = n / sum(n),
         Value = glue("{n} ({percent(pct)})")) |>
  mutate(Variable = "Imaging modality",
            Category = label,
            Value, 
            .keep = "none")
```

```{r n-sex}
# if want to redownload, set to TRUE
if(FALSE){
  imaging_data <- get_imaging_from_ier(data$ier_bk)

sex <- get_sex(imaging_data$PAT_BK)
birth_date <- get_birth(imaging_data$PAT_BK)

baseline_data <- imaging_data |> 
  left_join(birth_date, by = "PAT_BK") |>
  left_join(sex, by = "PAT_BK") |>
  mutate(
    age = as.numeric(difftime(IMAGING_DATE, PAT_BIRTH_DATE, units = "days"))/365.25
  ) |> 
  group_by(PAT_BK) |> 
  arrange(age) |> 
  slice_head(n = 1) |> 
  ungroup() |>
  select(age, sex = PAT_GENDER_ID) |> 
  distinct()

arrow::write_parquet(baseline_data, here::here("output", "oncology", "data", "baseline_data.parquet"))
} else {
  baseline_data <- read_parquet(here("output", "oncology", "data", "baseline_data.parquet"))
}

tbl_age <- baseline_data |> 
  summarise(
    n       = n(),
    mean    = mean(age),
    sd      = sd(age),
    median  = median(age),
    IQR_low = quantile(age, 0.25),
    IQR_high= quantile(age, 0.75)
  ) |> 
  mutate(
    Value = glue(
      "{mean |> round(1)}±{round(sd, digits = 1)}"),
    Variable = "Patient Characteristics" ,
    Category = "Age — yr"
  ) |> 
  select(Value, Variable, Category)

tbl_sex <- baseline_data |> 
  count(sex) |> 
  mutate(
    prop = n / sum(n)
  ) |> 
  mutate(
    Value = glue(
      "{n} ({prop |> percent()})"
    ),
    Variable = "Patient Characteristics",
    Category = "Female Sex"
  ) |> 
  filter(sex == "W") |> 
  select(Value, Variable, Category)
```

What were the three most common primary diagnoses (plus other) among the 400 reports?

```{r top3-diagnosis}
#| echo: false
#| output: false
# prep for table 1 - three most common diagnoses + other
diag_top4_other <- data |>
  filter(!str_detect(redcap_event_name, "LLM")) |> 
  filter(task == "Diagnosis") |>
  distinct(ier_bk, truth) |>
  count(truth, sort = TRUE, name = "n") |>
  (\(df) {
    top4 <- slice_head(df, n = 4)
    other_n <- sum(df$n) - sum(top4$n)
    out <- if (other_n > 0) bind_rows(top4, tibble(truth = "Other*", n = other_n)) else top4
    out |>
      mutate(
        pct   = round(n / sum(df$n), digits = 2),
        Value = glue::glue("{n} ({scales::percent(pct)})")
      )
  })() |>
  mutate(
    Variable = "Primary Diagnosis",
    Category = truth,
    Value,
    .keep = "none"
  )

diag_top4_other
```

Of the 400 reports, how many at least one metastasis?

```{r any-metastasis}
#| echo: false
#| output: false
# prep for table 1 - at least a metastasis

n_total_patients <- data |>
  distinct(ier_bk) |>
  nrow()

n_mets_patients <- data |>
  filter(!str_detect(redcap_event_name, "LLM")) |> 
  filter(task == "Metastasis") |>
  mutate(truth = tolower(trimws(truth))) |>
  group_by(ier_bk) |>
  summarise(any_mets = any(truth == "yes"), .groups = "drop") |>
  summarise(n = sum(any_mets)) |>
  pull(n)

tbl_mets_any <- tibble::tibble(
  Variable = "Metastasis",
  Category = "Any metastasis",
  Value = sprintf("%d (%.0f%%)", n_mets_patients, 100 * n_mets_patients / n_total_patients)
)

tbl_mets_any
```

On how many reports (our of the total of 400 reports), was a metastasis reported in the following locations?

```{r top3-metastasis}
#| echo: false
#| output: false
# prep for table 1 - Top 4 lok. of metastasis
mets_labels <- c(
  bone_metastasis          = "Bone",
  cns_metastasis           = "CNS",
  meningeal_metastasis     = "Meningeal",
  lung_metastasis          = "Lung",
  pleural_metastasis       = "Pleura",
  adrenal_metastasis       = "Adrenal",
  kidney_metastasis        = "Kidney",
  liver_metastasis         = "Liver",
  spleen_metastasis        = "Spleen",
  pancreas_metastasis      = "Pancreas",
  ovarian_metastasis       = "Ovary",
  peritoneal_metastasis    = "Peritoneum",
  lymph_node_metastasis    = "Lymph nodes",
  soft_tissue_metastasis   = "Soft tissue",
  other_organ_metastasis   = "Other organ"
)

tbl_mets_top4 <- data |>
  filter(!str_detect(redcap_event_name, "LLM")) |> 
  filter(task == "Metastasis") |>
  filter(truth == "Yes") |>
  mutate(
    Category = recode(
      item,
      !!!mets_labels,
      .default = stringr::str_to_sentence(
        gsub("_", " ", sub("_metastasis$", "", item, perl = TRUE))
      )
    )
  ) |>
  count(Category, name = "n") |>
  arrange(desc(n)) |>
  (\(df){
    top4 <- slice_head(df, n = 4)
    other_n <- sum(df$n) - sum(top4$n)
    if (other_n > 0) {
      bind_rows(top4, tibble(Category = "Other**", n = other_n))
    } else {
      top4
    }
  })() |>
  # keep order: top4 first, then Other
  mutate(
    pct   = n / n_total_patients,
    Value = sprintf("%d (%.0f%%)", n, 100 * pct),
    Variable = "Metastasis location"
  ) |>
  select(
    Variable,
    Category,
    Value
  )

tbl_mets_top4
```

```{r tbl-response-to-treatment}
#| echo: false
#| output: false
#prep for table 1 - rtt categories and distribution
resp_tbl <- data |>
  filter(!str_detect(redcap_event_name, "LLM") & task == "Response to Treatment") |> 
  distinct(ier_bk, pet_ct, truth) |>
  mutate(
    Category = str_trim(truth),
    Category = ifelse(is.na(Category) | Category == "", "NA", Category)
  ) |>
  count(pet_ct, Category, name = "n") |>
  group_by(pet_ct) |>
  mutate(
    p = n / sum(n),
    Value = sprintf("%d (%.0f%%)", n, 100 * p),
    Variable = paste0("Treatment response (", ifelse(pet_ct, "PET–CT", "CT/MRI"), ")")
  ) |>
  arrange(Variable, desc(n)) |>
  ungroup() |>
  select(Variable, Category, Value)
```

```{r tb-tumor_free-yes-no-na}
#| echo: false
#| output: false
tf_tbl <- data |>
  filter(!str_detect(redcap_event_name, "LLM") & task == "Radiologically Tumor Free") |>
  distinct(ier_bk, truth) |>
  mutate(
    Category = as.character(truth),             
    Category = ifelse(is.na(Category) | Category == "", "NA", Category)
  ) |>
  count(Category, name = "n") |>
  mutate(
    p = n / sum(n),
    Value = sprintf("%d (%.0f%%)", n, 100 * p),
    Variable = "Tumor-free status"
  ) |>
  arrange(desc(n)) |>
  select(
    Variable,
    Category,
    Value
  )
```

```{r tb-01}
#| echo: false
table1_df <- bind_rows(
  tbl_age,
  tbl_sex,
  modality_tbl,
  diag_top4_other,     
  tbl_mets_top4,
  resp_tbl,
  tf_tbl)

table1 <- gt(
  table1_df, 
  rowname_col = "Category", 
  groupname_col = "Variable") |>
  tab_header(title = md("**Table 1.**")) |>
  cols_label(Value = "") |>
  sub_missing(
    columns = everything(), 
    missing_text = "—") |>
  tab_options(
    table.font.size = px(13), 
    data_row.padding = px(6),
    row_group.background.color = "#fbf5d6ff") |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  ) |>
  opt_row_striping() 

gtsave(
  table1,
  filename = here::here("output", "oncology", "figures", "table1.docx")
)

table1
```

{{< pagebreak >}}

## Figure 1

```{r prep-data-analysis-optim-sample}
#| echo: false
full_sample <- data |> 
  mutate(
    human = if_else(!str_detect(redcap_event_name, "LLM"), 1, 0),
    grp = case_when(
      human == 1 ~ "human",
      model == "llama3.3:70b-instruct-q5_K_M" | model == "llama3.3:70b" ~ "llama3.3:70b",
      model == "mistral-small:24b-instruct-2501-q4_K_M" | model == "mistral-small:24b" ~ "mistral-small:24b",
      model == "rndcalcle01.qwen3:32b" | model == "qwen3:32b" ~ "qwen3:32b",
      model == "rndcalcle01.qwq:32b" | model == "qwq:32b" ~ "qwq:32b",
      model == "gpt-oss:120b" ~ "gpt-oss:120b",
    ),
    grp = factor(grp, levels = c("human", "llama3.3:70b", "mistral-small:24b", "qwen3:32b", "qwq:32b",  "gpt-oss:120b")) )

analysis_sample <- full_sample |> 
  group_by(ier_bk) |> 
  filter(any(training == "No")) |> 
  ungroup()

optim_sample <- full_sample |> 
  group_by(ier_bk) |> 
  filter(any(training == "Yes")) |> 
  ungroup()
```

```{r theme-for-figs}
#| echo: false
# Reusable theme for figs
theme_medical <- function(base_size = 11, base_family = "sans") {
  theme_minimal(base_size = base_size, base_family = base_family) +
    theme(
      panel.grid.major.x = element_line(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor   = element_blank(),
      axis.title = element_text(face = "bold"),
      axis.text  = element_text(color = "black"),
      axis.line  = element_line(linewidth = 0.4),
      axis.ticks = element_line(linewidth = 0.4),
      legend.position = "bottom",
      legend.direction = "horizontal",
      plot.margin = margin(5.5, 7, 5.5, 5.5)
    )
}
```

```{r model-predictions-comparisons}
#| echo: false
#| output: false
m_acc <- glm(
    correct ~ grp * task,
    data = analysis_sample  |> filter(task == "Metastasis" | task == "Response to Treatment"),
    family = binomial(link = "logit")
  )

avg_predictions(m_acc, by = c("grp", "task"), type = "response", vcov = ~ier_bk)
avg_comparisons(m_acc, variable = "grp", by = "task", type = "response", vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9)
```


```{r fig-main-primary-endpoints}
#| fig-width: 
#| fig-height:
#| fig-cap: "Difference & Accuracy Plot:  primary endppoints"
#| echo: false
#| warning: false
# -------- Palette & ordering (Okabe–Ito) ------------------------------------
okabe_ito_named <- c(
  human               = "#000000",
  "gpt-oss:120b"      = "#E69F00",
  "qwen3:32b"         = "#56B4E9",
  "qwq:32b"           = "#009E73",
  "mistral-small:24b" = "#0072B2",
  "llama3.3:70b"      = "#D55E00"
)

ord_legend    <- c("human","gpt-oss:120b","qwen3:32b","qwq:32b","mistral-small:24b","llama3.3:70b")
model_levels  <- setdiff(ord_legend, "human")
contrast_lvls <- paste0(model_levels, " - human")

shared_color <- scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE, name = "")
shared_fill  <- scale_fill_manual( values = okabe_ito_named, breaks = ord_legend, drop = FALSE, name = "", guide = "none")
diff_color   <- scale_color_manual(values = setNames(okabe_ito_named[model_levels], contrast_lvls),
                                   breaks = contrast_lvls, labels = model_levels, drop = FALSE)

# -------- Data for difference panels ----------------------------------------
dfm <- avg_comparisons(
  m_acc,
  newdata  = analysis_sample |> filter(task == "Metastasis"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> data.frame() |>
  mutate(contrast = factor(contrast, levels = contrast_lvls))

dfrtt <- avg_comparisons(
  m_acc,
  newdata  = analysis_sample |> filter(task == "Response to Treatment"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> data.frame() |>
  mutate(contrast = factor(contrast, levels = contrast_lvls))

# Shared y-limits for difference panels
lims <- range(c(dfm$conf.low, dfm$conf.high, dfrtt$conf.low, dfrtt$conf.high, -0.05, 0), na.rm = TRUE)

# -------- TOP: Accuracy (A, B) ----------------------------------------------
# Enforce identical x order by factoring 'grp' in newdata
new_m   <- analysis_sample |> filter(task == "Metastasis") |> mutate(grp = factor(grp, levels = ord_legend))
new_rtt <- analysis_sample |> filter(task == "Response to Treatment") |> mutate(grp = factor(grp, levels = ord_legend))

theme_top <- theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank()
  )


pred_data_m <- avg_predictions(
  m_acc, 
  newdata = new_m, 
  by = c("task", "grp"), 
  type = "response", 
  vcov = ~ier_bk
) |> 
  data.frame() |>
  mutate(grp = factor(grp, levels = ord_legend))

pred_data_rtt <- avg_predictions(
  m_acc, 
  newdata = new_rtt, 
  by = c("task", "grp"), 
  type = "response", 
  vcov = ~ier_bk
) |> 
  data.frame() |>
  mutate(grp = factor(grp, levels = ord_legend))

# Build plots manually with position control
pA <- ggplot(pred_data_m, aes(x = grp, y = estimate, color = grp, fill = grp)) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.8),  # Adjust this for spacing
    size = 0.8,
    linewidth = 0.8
  ) +
  shared_color + shared_fill +
  scale_y_continuous(limits = c(0.5, 1), breaks = seq(0.5, 1, 0.1)) +
  scale_x_discrete(expand = expansion(add = c(0.6, 0.6))) +
  labs(tag = "A)", x = NULL, y = "Probability of Correct Response", title = "Metastasis") +
  theme_top

pB <- ggplot(pred_data_rtt, aes(x = grp, y = estimate, color = grp, fill = grp)) +
  geom_pointrange(
    aes(ymin = conf.low, ymax = conf.high),
    position = position_dodge(width = 0.8),  # Adjust this for spacing
    size = 0.8,
    linewidth = 0.8
  ) +
  shared_color + shared_fill +
  scale_y_continuous(limits = c(0.5, 1), breaks = seq(0.5, 1, 0.1)) +
  scale_x_discrete(expand = expansion(add = c(0.6, 0.6))) +
  labs(tag = "B)", x = NULL, y = NULL, title = "Response to Treatment") +
  theme_top


# -------- BOTTOM: Difference vs. human (C, D) --------------------------------
theme_bottom <- theme_medical() +
  theme(
    axis.text.x  = element_blank(),
    axis.ticks.x = element_blank(),
    axis.title.x = element_blank(),
    panel.grid.major.y = element_line(colour = "grey85"),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  )

pC <- ggplot(dfm, aes(x = contrast, y = estimate)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(tag = "A)", title = "Metastasis", x = NULL) +
  theme_medical()

pD <- ggplot(dfrtt, aes(x = contrast, y = estimate)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(tag = "B)", title = "Response to Treatment", x = NULL) +
  theme_medical()

# -------- Assemble & save ----------------------------------------------------
fig1 <- (pA + pB) + 
  plot_layout(guides = "collect") +
  plot_annotation(theme = theme(legend.position = "bottom"))

fig1_supp <- pC/ pD

ggsave(
  filename = here::here("output", "oncology", "figures", "full_fig_primary.png"),
  plot = fig1, width = 8, height = 8, dpi = 300
)

ggsave(
  filename = here::here("output", "oncology", "figures", "full_fig_primary.svg"),
  plot = fig1, width = 8, height = 8, dpi = 300
)
```

## Table 2

```{r}
ord <- c(
  "human",
  "gpt-oss:120b",
  "qwen3:32b",
  "qwq:32b",
  "mistral-small:24b",
  "llama3.3:70b")

tab_data <- avg_comparisons(
  m_acc, variable = "grp", by = "task", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.90
) |>
  as_tibble() |>
  mutate(
    grp = str_remove(contrast, " - human") |> factor(levels = ord),
    # Pre-multiply p-value threshold logic if desired, or handle in gt
  ) |>
  arrange(task, grp) |>
  select(task, grp, estimate, conf.low, conf.high, p.value.noninf)

# 2. Build Table
tab_data |>
  gt(groupname_col = "task") |>
  # Format the numbers
  fmt_number(columns = c(estimate, conf.low, conf.high), decimals = 1,
    scale_by = 100) |>
  # Merge them into the specific pattern
  cols_merge(
    columns = c(estimate, conf.low, conf.high),
    pattern = "{1} ({2} to {3})"
  ) |>
  # Handle P-values (using scales makes this very concise)
  fmt(
    columns = p.value.noninf,
    fns = scales::label_pvalue(accuracy = 0.001) 
  ) |>
  # Labels and Styling
  cols_label(
    grp = "Contrast",
    estimate = "Difference in Accuracy (90% CI)",
    p.value.noninf = "P-value"
  ) |>
  # Add " - human" back visually without mutating data
  text_transform(
    locations = cells_body(columns = grp),
    fn = function(x) paste(x, "- human")
  ) |>
  tab_options(data_row.padding = px(4)) |>
  gtsave(filename = here::here("output", "oncology", "figures", "table_2.docx"))
```

## Figure 2

```{r model-predictions-comparisons-Diagnosis-RadiologicallyTumorFree}
#| echo: false
#| output: false

m_acc2 <- glm(
    correct ~ grp * task,
    data = analysis_sample  |> filter(task == "Diagnosis" | task == "Radiologically Tumor Free"),
    family = binomial(link = "logit")
  )

avg_predictions(m_acc2, by = c("grp", "task"), type = "response", vcov = ~ier_bk)
avg_comparisons(m_acc2, variable = "grp", by = "task", type = "response", vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9)
```

```{r model-predictions-comparisons-Overall}
#| echo: false
#| output: false

m_acc3 <- glm(
    correct ~ grp * task,
    data = analysis_sample, 
    family = binomial(link = "logit") )

avg_predictions(m_acc3,by = "grp", type = "response", vcov = ~ ier_bk)
avg_comparisons(m_acc3, variable = "grp", type = "response", vcov = ~ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9)
```

#### Diffrence plot: secondary endpoints

```{r fig-diff-secondary-endpoints}
#| echo: false
#| warning: false
#| fig-cap: "Non-inferiority analysis of LLM vs. human accuracy for primary tumor diagnosis, radiological absence of tumor, and overall performance."
#| fig-height: 3.5
#| fig-width: 6

## 1) DATA --------------------------------------------------------

# Diagnosis
dfd <- avg_comparisons(
  m_acc2,
  newdata = analysis_sample |> filter(task == "Diagnosis"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> 
  data.frame()

# Tumor free
dfrtf <- avg_comparisons(
  m_acc2,
  newdata = analysis_sample |> filter(task == "Radiologically Tumor Free"),
  variable = "grp", by = "task", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> 
  data.frame()

# Overall accuracy
dfover <- avg_comparisons(
  m_acc3,
  variable = "grp", type = "response",
  vcov = ~ ier_bk, equivalence = c(-0.05, Inf), conf_level = 0.9
) |> 
  data.frame()

dfd$contrast   <- factor(dfd$contrast,   levels = contrast_lvls)
dfrtf$contrast <- factor(dfrtf$contrast, levels = contrast_lvls)
dfover$contrast<- factor(dfover$contrast,levels = contrast_lvls)

## 2) LIMITS ------------------------------------------------------
lims <- range(
  c(
    dfd$conf.low,   dfd$conf.high,
    dfrtf$conf.low, dfrtf$conf.high,
    dfover$conf.low,dfover$conf.high,
    -0.05, 0
  ),
  na.rm = TRUE
)

## 3) PLOTS -------------------------------------------------------

p_diag <- ggplot(dfd, aes(x = contrast, y = estimate)) +
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high)) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(title = "Diagnosis", x = NULL) +
  theme_medical()

p_tf <- ggplot(dfrtf, aes(x = contrast, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(title = "Radiologically Tumor Free", x = NULL) +
  theme_medical()

p_over <- ggplot(dfover, aes(x = contrast, y = estimate)) +
  geom_point() +
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high), width = 0) +
  geom_hline(yintercept = 0,     linetype = "dotted") +
  geom_hline(yintercept = -0.05, linetype = "solid", color = "red") +
  scale_y_continuous(limits = lims, expand = expansion(mult = 0.02)) +
  coord_flip() +
  labs(title = "Overall accuracy", x = NULL) +
  theme_medical()

## 4) PATCHWORK ---------------------------------------------------

combined_sec <- p_diag / p_tf / p_over + plot_annotation(tag_levels = "A")

combined_sec   

## 5) SAVE --------------------------------------------------------------

ggsave(
  filename = here("output", "oncology", "figures", "secondary_contrast.png"),
  plot = combined_sec,
  width = 8, height = 10.5, dpi = 300
)
```

#### Accuracy by task (diagnosis, tumorfree) and group

```{r fig-acc-secondary-endpoints}
#| fig-width: 8
#| fig-height: 6
#| fig-cap: "Accuracy by Task and Group (Human vs LLM)"
#| echo: false
#| warning: false

# --- PLOT 1: Diagnosis -------------------------------------------------------
p1 <- plot_predictions(m_acc2, newdata = analysis_sample |> filter(task == "Diagnosis"), 
                       by = c("task", "grp"), type = "response", vcov = ~ier_bk) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2)) +
  scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  scale_fill_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  labs(x = "Diagnosis", y = "Probability of Correct Response", color = "") +
  theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank()
  )

# --- PLOT 2: Radiologically Tumor Free --------------------------------------
p2 <- plot_predictions(m_acc2, newdata = analysis_sample |> filter(task == "Radiologically Tumor Free"), 
                       by = c("task", "grp"), type = "response", vcov = ~ier_bk) +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2)) +
  scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  scale_fill_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  labs(x = "Radiologically Tumor Free", y = NULL, color = "") +
  theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
    axis.text.x = element_blank()
  )
# --- PLOT 3: Overall (single x level "overall") ------------------------------
ap <- avg_predictions(
  m_acc3,
  by   = "grp",
  type = "response",
  vcov = ~ ier_bk
) |>
  mutate(xlab = "overall")   

pd <- position_dodge(width = 0.2)

p3 <- ggplot(ap, aes(x = xlab, y = estimate, color = grp)) +  
  geom_pointrange(aes(ymin = conf.low, ymax = conf.high), position = pd, size = 0.5, linewidth = 0.5) +
  scale_x_discrete(limits = "overall") +
  scale_y_continuous(
    limits = c(0, 1),
    breaks = seq(0, 1, by = 0.2)) +
  scale_color_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  scale_fill_manual(values = okabe_ito_named, breaks = ord_legend, drop = FALSE) +
  labs(x = "Overall", y = NULL, color = "") +
  theme_medical() +
  theme(
    panel.grid.major.y = element_line(),
    panel.grid.major.x = element_blank(),
        axis.text.x = element_blank(),
    legend.position = ""
  )
# --- COMBINE ----------------------------------------------------------------
combined_Acc <- p1 + p2 + p3 + plot_annotation(tag_levels = "A") + plot_layout(guides = "collect")  & theme(legend.position = "bottom")

# Preview in the document
combined_Acc

# --- SAVE ---------------------------------------------------------------------
ggsave(
  filename = here::here("output", "oncology", "figures", "secondary_accuracy.png"),
  plot = combined_Acc,
  width = 8, height = 7, dpi = 300
)
```

{{< pagebreak >}}

## Bar Plot Metastasis

```{r bar-plot-meta}
#| fig-width: 8
#| fig-height: 6
#| fig-cap: "Bar Plot Metastasis"
#| echo: false
#| warning: false

bar_meta <- analysis_sample |>
filter(task == "Metastasis") |>
mutate(
    y = dplyr::case_when(
      truth == "Yes" & correct == 1 ~ "True Positive",
      truth == "Yes" & correct == 0 ~ "False Negative",
      truth == "No"  & correct == 1 ~ "True Negative",
      truth == "No"  & correct == 0 ~ "False Positive"
    ),
    item = gsub("_metastasis$", "", item),
    item = gsub("_", " ", item),
    grp  = if (exists("ord_legend")) factor(grp, levels = ord_legend) else grp,
    y    = factor(y, levels = c("False Negative", "False Positive", "True Negative", "True Positive")),
    item = if (exists("ord_items_meta")) {
      factor(item, levels = ord_items_meta)
    } else {
      factor(item, levels = sort(unique(item)))
    }
  ) |>
  ggplot(aes(x = item, fill = y)) +
  geom_bar(position = "fill") +
  scale_fill_manual(
    values = c(
      "True Positive"  = "#0868ac",
      "True Negative"  = "#67a9cf",
      "False Positive" = "#cb181d",
      "False Negative" = "#fb6a4a"
    ),
    breaks = c("True Positive","True Negative","False Positive","False Negative"),
    drop = FALSE,
    name = "Response"
  ) +
  facet_wrap(~ grp) +
  coord_flip() +
  labs(
    x = "Metastasis Location",
    y = "Proportion"
  ) +
  theme(
    legend.position = "bottom"
  )

bar_meta

ggsave(
  filename = here::here("output", "oncology", "figures", "bar_plot_meta.png"),
  plot = bar_meta,
  width = 8, height = 7, dpi = 300
)
```

## Calculating time per report

```{r efficiency-human}
#| echo: false
#| output: false

df <- logs$data

# --- 2) Keep only "Update record ... (Extraction 1|2)" and drop Ground Truth / LLM1–4 ---
clean_extractions <- df %>%
  filter(
    str_detect(action, regex("^Update record\\b.*\\(Extraction [12]\\)", ignore_case = TRUE)),
    !str_detect(action, regex("\\b(Ground\\s*Truth|LLM\\s*[1-4])\\b", ignore_case = TRUE))
  )

# --- 3) Ensure timestamp is a proper datetime (so sorting is truly chronological) ---
if (!inherits(clean_extractions$timestamp, "POSIXt")) {
  clean_extractions <- clean_extractions %>%
    mutate(timestamp = ymd_hms(timestamp, quiet = TRUE))
}

# --- 4) Remove the oldest 400 entries for "schwenkej", then sort by user + time ---
clean_extractions <- clean_extractions %>%
  group_by(username) %>%
  arrange(timestamp, .by_group = TRUE) %>%
  filter(!(username == "schwenkej" & row_number() <= 400)) %>%
  ungroup() %>%
  arrange(username, timestamp)


# --- 5) Calculate approx time per report
time <- clean_extractions |> 
  group_by(username) |> 
  arrange(username, timestamp) |> 
  mutate(
    prev_time = lag(timestamp),
    gap = as.numeric(difftime(timestamp, prev_time, units = "secs")),
    gap_imp = if_else(gap <= 5 | gap >= 300, NA_real_, gap)
  ) |>
  ungroup() |>
  mutate(gap_imp = if_else(is.na(gap_imp), mean(gap_imp, na.rm = TRUE), gap_imp)) |>
  relocate(c(prev_time, gap, gap_imp), .after = "timestamp") |>
  summarise(
    mean_sec = mean(gap_imp, na.rm = TRUE),
    min_sec  = min(gap_imp,  na.rm = TRUE),
    max_sec  = max(gap_imp,  na.rm = TRUE)
  )
```

```{r efficiency-llm}
#| echo: false
#| output: false

llm_eff <- read_csv(here("data", "oncology", "model_iteration_durations.csv"))

# 1) Keep first two runs for gpt-oss:120b and sum them; drop other gpt-oss rows
gpt_sum <- llm_eff |>
  filter(model == "gpt-oss:120b") |>
  arrange(start_time) |>
  slice(1:2) |>                             
  summarise(model = "gpt-oss:120b",
            duration_secs = sum(duration_secs), .groups = "drop") |>
  mutate(per_report_secs = duration_secs / 300)

# 2) All other models: one row = one run, convert to per-report seconds
others <- llm_eff |>
  filter(model != "gpt-oss:120b") |>
  mutate(per_report_secs = duration_secs / 300) |>
  select(model, per_report_secs)

# 3) Combine and summarise per model
per_model <- bind_rows(
  gpt_sum |> select(model, per_report_secs),
  others
) |>
  group_by(model) |>
  summarise(
    mean_sec = mean(per_report_secs, na.rm = TRUE),
    mean_min = mean_sec / 60,
    .groups = "drop"
  )
```

```{r}
#| echo: false
#| tbl-cap: "Mean extraction time per report by extractor group."
# Combine human and LLM timing data
combined_timing <- bind_rows(
  # Human timing with range
  time |> 
    mutate(
      group = "human",
      mean_min = mean_sec / 60,
      min_min = min_sec / 60,
      max_min = max_sec / 60
    ) |> 
    select(group, mean_sec, mean_min, min_sec, max_sec, min_min, max_min),
  
  # LLM timing - rename and add NA for min/max
  per_model |> 
    rename(group = model) |> 
    mutate(
      min_sec = NA_real_,
      max_sec = NA_real_,
      min_min = NA_real_,
      max_min = NA_real_
    ) |>
    select(group, mean_sec, mean_min, min_sec, max_sec, min_min, max_min)
) |>
  # Shorten LLM names - keep only up to parameter count
  mutate(
    group = case_when(
      group == "llama3.3:70b-instruct-q5_K_M" ~ "llama3.3:70b",
      group == "mistral-small:24b-instruct-2501-q4_K_M" ~ "mistral-small:24b",
      TRUE ~ group
    ),
    group = factor(group, levels = c(
      "human", 
      "llama3.3:70b",
      "mistral-small:24b", 
      "qwen3:32b",
      "qwq:32b",
      "gpt-oss:120b"
    ))
  ) |>
  arrange(group)

# Create gt table with range for humans
tbl_timing <- combined_timing |>
  mutate(
    time_display = if_else(
      group == "human",
      sprintf("%.1f (%.1f–%.1f)", mean_min, min_min, max_min),
      sprintf("%.1f", mean_min)
    )
  ) |>
  select(group, time_display) |>
  gt() |>
  cols_label(
    group = "",
    time_display = "Mean Time per Report (minutes)"
  ) |>
  cols_align(align = "center", columns = time_display) |> 
  tab_options(data_row.padding = px(4))

tbl_timing
```
